from bio import *
Q,T = ['test/data/' + a for a in ('MT-orang.fa','MT-human.fa')]

@test
def align_test():
    for target in FASTA(Q) |> seqs:
        for query in FASTA(T) |> seqs:
            a = query @ target
            assert abs(a.score) == 3315  # edit distance
            assert str(a.cigar) == '8I1M10I1M1I2M4I1M1I1M7I1M3I1M2I1M1I2M3I1M2I2M3I1M2I2M7I3M3I1M1I1M1I10M3I1M2I2M1I2M5I1M2I1M4I7M1I1M1I1M1I1M1I1M5I1M6I3M1I2M2I1M8I1M1I2M2I2M2I1M3I1M3I1M1I1M2I1M4I4M1I1M3I1M1I1M2I1M4I1M13I1M1I2M1I1M1I2M9I1M2I1M10I2M4I2M1I1M1I1M2I1M11I1M2I1M2I1M8I1M7I1M16I1M1I1M6I2M15I2M24I2M10I1M4I2M18I1M4I1M1I1M1I1M11I1M55I1M3I3M1I1M8I2M3I1M5I1M6I2M1I1M5I1M7I3M17I4M3I1M6I3M1I3M4I2M1I2M2I1M2I1M1I2M1I1M4I1M2I1M1I1M1I1M11I1M1I1M3I1M6I3M3I1M1I1M3I1M9I1M1I1M4I1M6I3M2I2M5I2M3I1M7I1M1I7M7I1M1I2M3I2M2I2M2I3M3I1M2I1M1I2M1I1M2I1M5I1M2I1M1I3M1I1M4I2M3I2M2I1M2I1M1I3M7I1M2I163M1D559M1I6M1D550M1I2M1I148M1I3M1D134M1I3M1D47M1D696M1I52M1D7M1D61M1D592M1I3M1D485M1I5M1D1211M1I59M1I156M1I31M1D98M1D18M6D7M7D1M1D1542M1I4M1D70M1I345M1I9M1D397M1D1M6D3M4D1M1D1M2D3M1D1M1D8M2D6M1D390M1D5M1I193M1D6M1I195M1I7M1D1826M1I10M1D1256M1I49M1I1423M1D2M1I46M1I5M1D2137M1I3M1D50M1I3M1D40M1D3M4D57M1D53M3I1M1I19M1D39M15D1M1D1M2D1M5D5M1D1M1D5M1D6M1D7M1D2M1D1M3D1M4D1M4D1M2D3M1D1M1D3M2D1M1D8M4D5M1D5M1D2M3D1M1D2M3D3M1D2M1D3M4D3M1D2M3D6M1D1M1D6M2D5M1D4M8D1M1D1M4D2M1D5M1D1M2D1M3D5M2D2M1D1M3D1M2D5M2D2M1D1M1D2M5D1M3D1M1D10M8D1M1D3M2D3M4D1M6D1M1D1M6D3M2D2M1D5M1D1M2D5M1D4M1D1M1D2M9D1M3D1M9D1M1D1M3D3M1D1M1D1M3D2M5D1M4D1M8D1M1D1M4D3M7D2M1D1M2D1M2D1M1D2M2D12M1D2M4D3M1D2M3D1M1D10M2D3M3D1M2D1M2D2M2D1M4D1M3D3M3D1M2D1M4D1M5D1M7D4M6D1M2D1M1D1M2D1M1D1M3D2M1D2M5D1M2D2M1D1M3D2M1D1M2D1M2D2M1D2M3D6M2D2M1D1M1D1M1D3M1D2M8D2M1D2M2D6M1D6M1D1M3D5M4D2M5D2M1D2M1D3M9D2M2D2M6D1M7D1M1D2M9D1M3D2M4D2M7D10M11D2M2D1M7D1M1D1M1D2M1D2M4D1M1D1M4D2M4D1M1D1M5D2M2D1M2D7M4D1M1D1M1D4M4D4M1D1M1D1M8D10M3D2M2D1M1D1M1D6M3D6M1D3M1D6M1D7M3D1M1D4M2D3M1D17M1D3M'

    # ./ksw2-test test/MT-orang.fa test/MT-human.fa
    for target in FASTA(Q) |> seqs:
        for query in FASTA(T) |> seqs:
            a = query.align(target, a=2, b=4, gapo=4, gape=2, gapo2=13, gape2=1)
            assert a.score == 17127
            assert str(a.cigar) == '576I14M2I4M3D37M1I85M1I232M1D559M1I6M1D550M1I2M1I146M2D3M1I3M1I132M1I3M1D40M3D13M1I1M1I335M3D4M1I3M2I342M1I52M1D13M3D1M2I52M1D592M1I3M1D485M1I5M1D974M3D4M3I230M1I59M1I156M1I31M1D98M1D26M14D329M3D7M3I1203M1I4M1D70M1I345M1I9M1D398M7D8M8D1M1D9M3D2M1I2M1D390M1D5M1I193M1D6M1I195M1I7M1D1826M1I10M1D1256M1I49M1I157M3I5M3D48M2D1M1D3M3I1203M1D2M2I1M1D44M2I2M1D2M1D38M2I16M2D2081M1I3M1D50M1I3M1D43M5D57M1D54M4I19M1D39M2I8M1D7M1D22M1D5M1D4M1I5M1D2M2I29M2D20M1I13M1I1M2D8M1I45M1I15M3I4M2D17M1I56M1I2M1D131M1D37M474D1M'

    # ./ksw2-test -t exts2_sse test/MT-orang.fa test/MT-human.fa
    for target in FASTA(Q) |> seqs:
        for query in FASTA(T) |> seqs:
            a = query.align(target, a=1, b=2, gapo=2, gape=1, gapo2=32, gape2=4, splice=True, splice_fwd=True)
            assert a.score == 9027
            assert str(a.cigar) == '576I14M2I4M3D37M1I85M1I232M1D559M1I6M1D550M1I2M1I146M2D3M1I3M1I132M1I3M1D40M3D13M1I1M1I335M3D4M1I3M2I342M1I52M1D13M3D1M2I52M1D592M1I3M1D485M1I5M1D974M3D4M3I230M1I59M1I156M1I31M1D98M1D26M14D329M3D7M3I1203M1I4M1D70M1I345M1I9M1D398M7D8M8D1M1D9M3D2M1I2M1D390M1D5M1I193M1D6M1I195M1I7M1D1826M1I10M1D1256M1I49M1I157M3I5M3D48M2D1M1D3M3I1203M1D2M2I1M1D44M2I2M1D2M1D38M2I16M2D2081M1I3M1D50M1I3M1D43M5D57M1D54M4I19M1D39M2I8M1D7M1D22M1D5M1D4M1I5M1D2M2I29M2D20M1I13M1I1M2D8M1I45M1I15M3I4M2D17M1I56M1I2M1D131M1D37M474N1M'

    # ./ksw2-test -t gg2_sse test/MT-orang.fa test/MT-human.fa
    for target in FASTA(Q) |> seqs:
        for query in FASTA(T) |> seqs:
            a = query.align(target, a=2, b=4, gapo=4, gape=2)
            assert a.score == 16102
            assert str(a.cigar) == '1M155I4M63I5M103I4M56I3M6I4M192I37M1I85M1I232M1D559M1I6M1D550M1I2M1I146M2D3M1I3M1I132M1I3M1D40M3D13M1I1M1I335M3D4M1I3M2I342M1I52M1D13M3D1M2I52M1D592M1I3M1D485M1I5M1D974M3D4M3I230M1I59M1I156M1I31M1D98M1D26M14D329M3D7M3I1203M1I4M1D70M1I345M1I9M1D398M7D8M8D1M1D9M3D2M1I2M1D390M1D5M1I193M1D6M1I195M1I7M1D1826M1I10M1D1256M1I49M1I157M3I5M3D48M2D1M1D3M3I1203M1D2M2I1M1D44M2I2M1D2M1D38M2I16M2D2081M1I3M1D50M1I3M1D43M5D57M1D54M4I19M1D39M2I8M1D7M1D22M1D5M1D4M1I5M1D2M2I29M2D20M1I13M1I1M2D8M1I45M1I15M3I4M2D17M1I56M1I2M1D131M1D37M474D1M'

@test
def cigar_test():
    def check_cigar(s: str):
        return str(CIGAR(s)) == s

    def check_cigar_fail(s: str):
        try:
            CIGAR(s)
            return False
        except ValueError:
            return True

    assert check_cigar('')
    assert check_cigar('1M')
    assert check_cigar('11M')
    assert check_cigar('3M11I12H111D')
    assert check_cigar_fail('3M11I12q111D')
    assert check_cigar_fail('3M11I12H111')
    assert check_cigar_fail(' ')
    assert check_cigar_fail('M')
    assert check_cigar_fail('1')
    assert check_cigar_fail('M1')
    assert check_cigar_fail('MMM')
    assert check_cigar_fail('MM1')
    assert check_cigar_fail('M1M')
    assert check_cigar_fail('M11')
    assert check_cigar_fail('1MM')
    assert check_cigar_fail('1M1')
    assert check_cigar_fail('111')

    assert bool(CIGAR('')) == False
    assert bool(CIGAR('1M')) == True

align_test()
cigar_test()
