class DummyDict[K, V]:
    def __getitem__(self, k: K):
        raise ValueError('failed')
        return V()
    def get(self, k: K, d: V):
        raise ValueError('failed')
        return V()
    def __setitem__(self, k: K, v: V):
        assert False
    def __dict_do_op_throws__[F, Z](self, key: K, other: Z, op: F):
        pass
    def __dict_do_op__[F, Z](self, key: K, other: Z, dflt: V, op: F):
        pass

class WrappedDict[K, V]:
    d: Dict[K,V]
    do_op_throws_count: int
    do_op_count: int

    def __init__(self):
        self.d = {}
        self.do_op_throws_count = 0
        self.do_op_count = 0
    def __getitem__(self, k: K):
        return self.d.__getitem__(k)
    def get(self, k: K, d: V):
        return self.d.get(k, d)
    def __setitem__(self, k: K, v: V):
        self.d.__setitem__(k, v)
    def setdefault(self, k: K, v: V):
        return self.d.setdefault(k, v)

    def __dict_do_op_throws__[F, Z](self, key: K, other: Z, op: F):
        self.do_op_throws_count += 1
        self.d.__dict_do_op_throws__(key, other, op)
    def __dict_do_op__[F, Z](self, key: K, other: Z, dflt: V, op: F):
        self.do_op_count += 1
        self.d.__dict_do_op__(key, other, dflt, op)

@test
def test_dict_op():
    x = DummyDict[int, int]()
    x[1] = x[1] + 1
    x[1] = x.get(1, 1) + 1
test_dict_op()

@test
def test_dict_do_not_op():
    x = DummyDict[int, int]()
    try:
        x[1] = x[2] + 1
    except ValueError:
        return
    assert False
test_dict_do_not_op()

@test
def test_wrapped_dict():
    def my_op(a, b):
        return a * b
    def my_op_throws(a, b):
        raise ValueError('my_op_throws')
        return a * b

    x = WrappedDict[str, str]()
    x['a'] = x.get('a', '0') + '1'
    x['a'] = x['a'] * 2
    x['b'] = x.setdefault('b', 'x') + 'y'
    x['a'] += x['b']
    x['b'] = my_op(x['b'], 2)
    foo = x['a']
    x['a'] = x['b'] + foo

    try:
        x['c'] += 'one'
        assert False
    except KeyError:
        pass

    try:
        x['d'] = my_op_throws(x['d'], 2)
        assert False
    except KeyError:
        pass

    try:
        x['d'] = my_op_throws(x.get('d', 'aaa'), 2)
        assert False
    except ValueError:
        pass

    assert x.do_op_throws_count == 5
    assert x.do_op_count == 2
    assert x.d == {'a': 'xyxy0101xy', 'b': 'xyxy'}
test_wrapped_dict()
